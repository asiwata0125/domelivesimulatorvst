name: Build VST3 Plugin

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and extract JUCE
        shell: pwsh
        run: |
          Write-Host "Downloading JUCE..."
          Invoke-WebRequest -Uri "https://github.com/juce-framework/JUCE/releases/download/8.0.4/juce-8.0.4-windows.zip" -OutFile "juce.zip"
          Write-Host "Extracting JUCE..."
          Expand-Archive -Path "juce.zip" -DestinationPath "."
          Write-Host "JUCE extracted to ./JUCE"
          Get-ChildItem "JUCE" | Select-Object Name

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -B build -S . -G "Visual Studio 17 2022" -A x64

      - name: Build VST3 (Release)
        shell: pwsh
        run: |
          cmake --build build --config Release --parallel

      - name: List build outputs
        shell: pwsh
        run: |
          Write-Host "Searching for VST3 files..."
          Get-ChildItem -Path "build" -Recurse -Filter "*.vst3" -Directory | Select-Object FullName
          Get-ChildItem -Path "build" -Recurse | Where-Object { $_.FullName -like "*VST3*" } | Select-Object FullName

      - name: Upload VST3 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DomeLiveSimulator-VST3-Windows
          path: build/DomeLiveSimulator_artefacts/Release/VST3/
          retention-days: 30

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: DomeLiveSimulator-VST3-Windows
          path: DomeLiveSimulator-VST3

      - name: Create ZIP
        run: zip -r DomeLiveSimulator-VST3-Windows.zip DomeLiveSimulator-VST3

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ steps.date.outputs.date }}
          name: DomeLiveSimulator v1.0.0
          body: |
            ## Dome Live Simulator VST3

            東京ドームのようなアリーナ音響をエミュレートするVST3プラグイン

            ### インストール方法
            1. ZIPを解凍
            2. `DomeLiveSimulator.vst3` フォルダを `C:\Program Files\Common Files\VST3\` にコピー
            3. DAWでプラグインをスキャン
          files: DomeLiveSimulator-VST3-Windows.zip
          draft: false
          prerelease: false
