name: Build VST3 Plugin

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download and extract JUCE
        shell: pwsh
        run: |
          Write-Host "Downloading JUCE..."
          Invoke-WebRequest -Uri "https://github.com/juce-framework/JUCE/releases/download/8.0.4/juce-8.0.4-windows.zip" -OutFile "juce.zip"
          Write-Host "Extracting JUCE..."
          Expand-Archive -Path "juce.zip" -DestinationPath "C:\"
          Write-Host "JUCE extracted. Checking contents..."
          Get-ChildItem "C:\JUCE" | Select-Object Name
          Get-ChildItem "C:\JUCE\modules" -Directory | Select-Object Name -First 5

      - name: Update jucer file module paths
        shell: pwsh
        run: |
          Write-Host "Updating .jucer file module paths..."
          $content = Get-Content "DomeLiveSimulator.jucer" -Raw
          # 既存のパスをCI環境用に更新
          $content = $content -replace 'path="C:/JUCE/modules"', 'path="C:/JUCE/modules"'
          $content = $content -replace 'path="C:\\JUCE\\modules"', 'path="C:/JUCE/modules"'
          Set-Content "DomeLiveSimulator.jucer" -Value $content
          Write-Host "Updated .jucer file"

      - name: Generate Visual Studio Project with Projucer
        shell: pwsh
        run: |
          Write-Host "Running Projucer to generate VS project..."
          $projucerPath = "C:\JUCE\Projucer.exe"
          if (Test-Path $projucerPath) {
            Write-Host "Projucer found at $projucerPath"
            & $projucerPath --resave "$PWD\DomeLiveSimulator.jucer"
            Write-Host "Projucer finished. Exit code: $LASTEXITCODE"
          } else {
            Write-Host "ERROR: Projucer not found at $projucerPath"
            Get-ChildItem "C:\JUCE" -Recurse -Filter "*.exe" | Select-Object FullName
            exit 1
          }

          # Projucerが生成したファイルを確認
          Start-Sleep -Seconds 3
          Write-Host "Checking for generated files..."
          Get-ChildItem -Recurse -Depth 2 | Where-Object { $_.Name -like "*.sln" -or $_.Name -like "*.vcxproj" } | Select-Object FullName

      - name: Verify Builds folder exists
        shell: pwsh
        run: |
          if (Test-Path "Builds\VisualStudio2022\DomeLiveSimulator.sln") {
            Write-Host "SUCCESS: Solution file found!"
          } else {
            Write-Host "ERROR: Solution file not found!"
            Write-Host "Current directory contents:"
            Get-ChildItem -Recurse -Depth 3 | Select-Object FullName
            exit 1
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build VST3 (Release)
        shell: pwsh
        run: |
          Write-Host "Building VST3..."
          msbuild "Builds\VisualStudio2022\DomeLiveSimulator.sln" /p:Configuration=Release /p:Platform=x64 /m

      - name: Upload VST3 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DomeLiveSimulator-VST3-Windows
          path: Builds/VisualStudio2022/x64/Release/VST3/DomeLiveSimulator.vst3/
          retention-days: 30

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: DomeLiveSimulator-VST3-Windows
          path: DomeLiveSimulator.vst3

      - name: Create ZIP
        run: zip -r DomeLiveSimulator-VST3-Windows.zip DomeLiveSimulator.vst3

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ steps.date.outputs.date }}
          name: DomeLiveSimulator v1.0.0
          body: |
            ## Dome Live Simulator VST3

            東京ドームのようなアリーナ音響をエミュレートするVST3プラグイン

            ### インストール方法
            1. ZIPを解凍
            2. `DomeLiveSimulator.vst3` フォルダを `C:\Program Files\Common Files\VST3\` にコピー
            3. DAWでプラグインをスキャン
          files: DomeLiveSimulator-VST3-Windows.zip
          draft: false
          prerelease: false
